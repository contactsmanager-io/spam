name: Format Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  format-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          npm install -g prettier jq

      - name: Debug - List files
        run: |
          echo "ğŸ“ Listing workspace contents..."
          ls -la
          echo ""
          echo "ğŸ“ Listing patterns directory..."
          if [ -d "patterns" ]; then
            ls -la patterns/
          else
            echo "âŒ patterns directory not found"
          fi
          echo ""
          echo "ğŸ“ Listing blocklists directory..."
          if [ -d "blocklists" ]; then
            ls -la blocklists/
          else
            echo "âŒ blocklists directory not found"
          fi
          echo ""
          echo "ğŸ“ Listing schemas directory..."
          if [ -d "schemas" ]; then
            ls -la schemas/
          else
            echo "âŒ schemas directory not found"
          fi

      - name: Check JSON formatting
        run: |
          echo "ğŸ” Checking JSON formatting..."
          echo "Using jq version: $(jq --version)"
          echo ""

          # Check if all JSON files are properly formatted
          files_to_check=(
            "patterns/phone-patterns.json"
            "patterns/email-patterns.json" 
            "patterns/domain-patterns.json"
            "blocklists/phone-numbers.json"
            "blocklists/email-addresses.json"
            "blocklists/domains.json"
            "schemas/phone-pattern.schema.json"
            "schemas/email-pattern.schema.json"
            "schemas/phone-blocklist.schema.json"
            "schemas/email-blocklist.schema.json"
            "schemas/domain-blocklist.schema.json"
          )

          formatting_issues=false

          for file in "${files_to_check[@]}"; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“„ Processing file: $file"
            
            if [ -f "$file" ]; then
              echo "âœ… File exists"
              
              # Show file size and basic info
              file_size=$(wc -c < "$file")
              line_count=$(wc -l < "$file")
              echo "ğŸ“Š File size: $file_size bytes, Lines: $line_count"
              
              # Show first few characters to detect encoding issues
              echo "ğŸ”¤ First 100 characters:"
              head -c 100 "$file" | cat -v
              echo ""
              
              # Show last few characters to detect truncation
              echo "ğŸ”¤ Last 100 characters:"
              tail -c 100 "$file" | cat -v
              echo ""
              
              # Check if file is valid JSON with detailed error output
              echo "ğŸ” Validating JSON syntax..."
              json_error=$(jq empty "$file" 2>&1)
              if [ $? -ne 0 ]; then
                echo "âŒ $file contains invalid JSON"
                echo "ğŸ“ Detailed error output:"
                echo "$json_error"
                echo ""
                echo "ğŸ“„ File content (first 20 lines):"
                head -20 "$file" | cat -n
                echo ""
                echo "ğŸ“„ File content (last 20 lines):"
                tail -20 "$file" | cat -n
                echo ""
                formatting_issues=true
                continue
              else
                echo "âœ… JSON syntax is valid"
              fi
              
              # Check if file is properly formatted (2-space indentation)
              echo "ğŸ¨ Checking JSON formatting..."
              formatted_content=$(jq --indent 2 . "$file" 2>&1)
              if [ $? -ne 0 ]; then
                echo "âŒ Failed to format $file"
                echo "ğŸ“ jq format error:"
                echo "$formatted_content"
                formatting_issues=true
                continue
              fi
              
              original_content=$(cat "$file")
              
              if [ "$formatted_content" != "$original_content" ]; then
                echo "âŒ $file is not properly formatted"
                echo ""
                echo "ğŸ“Š Content length comparison:"
                echo "  Original: $(echo "$original_content" | wc -c) characters"
                echo "  Formatted: $(echo "$formatted_content" | wc -c) characters"
                echo ""
                echo "ğŸ” First difference (showing first 20 lines of expected format):"
                echo "$formatted_content" | head -20 | cat -n
                echo "..."
                echo ""
                echo "ğŸ” Current format (first 20 lines):"
                echo "$original_content" | head -20 | cat -n
                echo ""
                formatting_issues=true
              else
                echo "âœ… $file is properly formatted"
              fi
            else
              echo "âš ï¸  $file not found, skipping..."
              echo "ğŸ” Checking if directory exists..."
              dir_path=$(dirname "$file")
              if [ -d "$dir_path" ]; then
                echo "âœ… Directory $dir_path exists"
                echo "ğŸ“ Contents of $dir_path:"
                ls -la "$dir_path"
              else
                echo "âŒ Directory $dir_path does not exist"
              fi
            fi
            echo ""
          done

          if [ "$formatting_issues" = true ]; then
            echo ""
            echo "âŒ Formatting issues found. Please run 'jq --indent 2 . file.json > temp && mv temp file.json' to fix formatting."
            exit 1
          fi

          echo "âœ… All JSON files are properly formatted"

      - name: Check for required fields
        run: |
          echo "ğŸ” Checking for required fields..."

          # Check that all files have version and last_updated
          required_check=true

          for file in patterns/*.json blocklists/*.json; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“„ Checking required fields in $file..."
            
            if [ -f "$file" ]; then
              echo "âœ… File exists"
              
              # Extract fields with detailed error handling
              echo "ğŸ” Extracting version field..."
              version=$(jq -r '.version // empty' "$file" 2>&1)
              if [ $? -ne 0 ]; then
                echo "âŒ Error extracting version from $file:"
                echo "$version"
                required_check=false
                continue
              fi
              
              echo "ğŸ” Extracting last_updated field..."
              last_updated=$(jq -r '.last_updated // empty' "$file" 2>&1)
              if [ $? -ne 0 ]; then
                echo "âŒ Error extracting last_updated from $file:"
                echo "$last_updated"
                required_check=false
                continue
              fi
              
              echo "ğŸ“Š Extracted values:"
              echo "  Version: '$version'"
              echo "  Last Updated: '$last_updated'"
              
              if [ -z "$version" ]; then
                echo "âŒ $file missing 'version' field"
                echo "ğŸ” Available top-level fields:"
                jq -r 'keys[]' "$file" 2>/dev/null || echo "Could not extract keys"
                required_check=false
              fi
              
              if [ -z "$last_updated" ]; then
                echo "âŒ $file missing 'last_updated' field"
                echo "ğŸ” Available top-level fields:"
                jq -r 'keys[]' "$file" 2>/dev/null || echo "Could not extract keys"
                required_check=false
              fi
              
              # Check version format (semantic versioning)
              if [ -n "$version" ]; then
                echo "ğŸ” Validating version format: $version"
                if [[ ! $version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                  echo "âŒ $file has invalid version format: $version (expected: X.Y.Z)"
                  echo "ğŸ“ Version should match semantic versioning pattern (e.g., 1.0.0)"
                  required_check=false
                else
                  echo "âœ… Version format is valid"
                fi
              fi
              
              # Check date format
              if [ -n "$last_updated" ]; then
                echo "ğŸ” Validating date format: $last_updated"
                if [[ ! $last_updated =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
                  echo "âŒ $file has invalid date format: $last_updated (expected: YYYY-MM-DD)"
                  echo "ğŸ“ Date should be in ISO format (e.g., 2025-01-15)"
                  required_check=false
                else
                  echo "âœ… Date format is valid"
                fi
              fi
            else
              echo "âŒ File not found: $file"
              required_check=false
            fi
            echo ""
          done

          if [ "$required_check" = false ]; then
            echo "âŒ Required field validation failed"
            exit 1
          fi

          echo "âœ… All required fields are present and valid"
